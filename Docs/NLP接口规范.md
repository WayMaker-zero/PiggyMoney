# NLP 记账接口规范（占位设计）

目标：为“把一段话自动解析成多笔账”提供稳定的接口契约。当前阶段不内置模型与调用，只定义接口、输入输出与错误语义，便于后续对接任意提供商（本地/云端）。

## 1. 接口概览（TypeScript）
```ts
// ports/nlp.ts
export interface INlpParser {
  parse(text: string): Promise<Transaction[]>;
}
```

- 入参：
  - `text`: 用户输入的一段自然语言文本（支持多语种，UTF-8）。
- 出参：
  - `Transaction[]`: 结构化交易数组；未写入数据库，由应用层复用“新增账目”流程进行校验与确认。

## 2. Transaction 字段要求
- `amount`: number，>0，单位为主货币的最小单位（默认为元）。
- `type`: `'income' | 'expense'`，收入或支出。
- `date`: ISO 日期字符串 `YYYY-MM-DD`（若解析不到，则可用当天日期）。
- `note`: 备注（可选），从原句抽取。
- `tags`: 标签字符串数组（可选），如 `['餐饮','交通']`。
- `userId`: 由应用层在写入前补全（解析阶段可缺省）。
- `id`: 由应用层生成（解析阶段可缺省）。

## 3. 典型输入输出
- 输入：
  - “今天午饭35，地铁5，报销到手200”
- 输出（示例）：
```json
[
  { "id":"", "userId":"", "amount":35, "type":"expense", "date":"2025-09-25", "note":"午饭", "tags":["餐饮"] },
  { "id":"", "userId":"", "amount":5,  "type":"expense", "date":"2025-09-25", "note":"地铁", "tags":["交通"] },
  { "id":"", "userId":"", "amount":200,"type":"income",  "date":"2025-09-25", "note":"报销入账" }
]
```

## 4. 错误与不确定性处理
- 解析失败：`throw new Error('PARSE_FAILED')`；UI 提示用户改用手动记账。
- 信息缺失：
  - 金额缺失：丢弃该条或标注为不完整（后续可扩展返回 `incomplete: true`）。
  - 日期缺失：默认当天。
  - 类型模糊：可返回 `type: 'expense'` 并附带 `note` 解释（由用户确认）。

## 5. 国际化与多语种
- 接口不限定语种；处理方可采用不同模型与提示词模板。
- 日期格式解析建议统一归一到 ISO；货币符号解析（￥/$/€ 等）由实现方决定是否支持。

## 6. 安全与隐私
- 默认在本地解析优先；如需调用云端服务，必须在设置页明确获得用户授权并提示可能的敏感信息外发。

## 7. 集成建议
- UI 流程：
  1) 用户输入一段话 → 调用 `INlpParser.parse(text)`；
  2) 预览解析结果列表（可编辑金额/日期/备注/类型/标签）；
  3) 用户确认后，逐条调用新增账目用例写入。
- 可插拔：通过依赖倒置，将解析器以适配器形式注入，便于切换供应商或本地实现。

